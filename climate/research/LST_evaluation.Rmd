
LST Temporal Aggregation Evaluation
====
```{r,echo=FALSE,message=FALSE}
## get repo info
githash=system("git --git-dir /Users/adamw/work/environmental-layers/.git log --pretty=format:'%h' -n 1",intern=T)
ghead=paste("Compiled on",date()," using code hash:",githash)
```

### Adam M. Wilson and Giuseppe Amatulli
(`r ghead`)

A short script to explore the implications of a 3-month moving window Land Surface Temperature Climatology.

```{r,echo=FALSE,results='hide',message=F}
## some setup
uploadimages=F  # upload all images to imgur.com for easy viewing on github
opts_knit$set(progress = TRUE, verbose = TRUE,root.dir="~/Downloads",base.url = NULL)
if(uploadimages) opts_knit$set(upload.fun =imgur_upload)

opts_chunk$set(fig.width=12, fig.height=8, cache=!uploadimages)

### libraries
library(sp)
library(reshape)
library(plyr)
library(latticeExtra)

## Import the data
setwd("~")
dlst=read.csv("/Users/adamw/Downloads/lst_tmax.csv")

## add month names
dlst$month=factor(month.name[dlst$month],ordered=T,levels=month.name)

## add 3 month moving window
dlst2=unique(dlst[,c("station","month","TMax","lst","lstp1","lstm1")])
dlst2$lst3m=apply(dlst2[,c("lst","lstp1","lstm1")],1,mean)
dlst2$lst2m=apply(dlst2[,c("lstp1","lstm1")],1,mean)

```

# Data
The following data were extracted from the shapefiles used to fit the tiled interpolations that Alberto has already run. They are limited to the CONUS region and include mean monthly maximum temperature observed at the station locations, as well as the LST from the month before, the month of, and the month following.  Here's what the data look like:

```{r,results="asis", echo=F}
kable(head(dlst[,-1]), format="markdown")
```


# TMax~LST relationship seasonal variability 

First let's explore the variability of the TMax~LST relationship by month, grouped by tile.  In this plot grey lines indicate a Tmax~LST regression within each tile (stations may be present in multiple tiles). Variability among grey lines represents spatial variability in the fitted lapse rate and the heavy black line is overall mean relationship (by month).
```{r,echo=FALSE}
xyplot (TMax~lst | month, groups=tile,data=dlst , 
        main="Tmax~LST at station locations by month",
        sub="Colors indicate  initial tiled-CONUS TMAX interpolation",
        ylab="Observations Tmax", xlab="LST",cex=.2,pch=16,auto.key=list(space="right"))+
  layer(panel.abline(0,1,lwd=3,col="black"))+
  glayer(panel.abline(lm (y~x),col="grey"),groups=dlst$tile,under=T)
```


# Comparison of monthly means with 3-month moving window
Here we compare the monthly means with a three month moving window (e.g. January mean LST with December-February mean LST).  Note that the relationship is very good (R^2 >0.95) but slightly weaker in winter months, likely due primarily to seasonal minimums.  Heavy black line is 1:1, and thin line is the fitted regression.

```{r,echo=FALSE}
xyplot (lst~lst3m | month,data=dlst2 , 
        main="Tmax~LST at station locations by month",
        ylab="LST (monthly)", xlab="LST (3-month Mean)",cex=.5,pch=16,auto.key=list(space="right"))+
  layer(panel.abline(0,1,lwd=3,col="black"))+
  layer(panel.ablineq(lm(y ~ x), r.sq = TRUE, at = 0.1, digits=2,adj=0:1,pos=4,offset=3,col="black"), style = 2)

```

# Comparison of monthly means with 2-month moving window that does not include the month
Here we compare the monthly means with a two month moving window that does not include the month of interest (e.g. January mean LST with December and February mean LST, but not including the January LST).  Heavy black line is 1:1, and thin line is the fitted regression.

```{r,echo=FALSE}
xyplot (lst~lst2m | month,data=dlst2 , 
        main="LST at station locations by month",
        ylab="LST (monthly)", xlab="LST (2-month Mean)",cex=.5,pch=16,auto.key=list(space="right"))+
  layer(panel.abline(0,1,lwd=3,col="black"))+
  layer(panel.ablineq(lm(y ~ x), r.sq = TRUE, at = 0.2, digits=2,adj=0:1,pos=4,offset=2,col="black"), style = 2)

```

Now let's look at the differences between the 1-month and 2-month LST values.  These represent a measure of how wrong we would be if we only had data from the two surrounding months and not the month in question.  

```{r,fig.height=3}
histogram(dlst2$lst-dlst2$lst2m,col="grey",xlab="Anomolies (1 month - 2 month means)")
```
The 95th quantile of the absolute value is only `r round(quantile(abs(dlst2$lst-dlst2$lst2m),na.rm=T,0.95),1)`, so the differences are quite small. From this analysis, it appears that broadening the temporal window will maintain a relatively consistent estimate of LST (R^2 ranged from 0.88-0.9) even when using only data from the surrounding months.

Let's see how the seasonal cycle is represented by these proxies for a few randomly selected stations.  Here the red line is the observed TMax data, the heavy black line represents the mean LST in that month, and the green line is a three-month moving window, while the purple line is the 2-month window (not including the month of interest).

```{r}
dlst2l=melt(dlst2,id.vars=c("station","month"),measure.vars=c("TMax","lst","lst3m","lst2m"))
ss=sample(dlst2l$station,10)
```

```{r,echo=FALSE}
trellis.par.set(superpose.line = list(col = c("red","black","green","blue"),lwd=c(2,2,1,1)),
                superpose.symbol = list(col = c("red","black","green","blue"),lwd=c(2,2,1,1)))
xyplot (value~month|station, data=dlst2l[dlst2l$station%in%ss,], groups=variable,type="l",
        main="LST at station locations by month",
        ylab="LST (monthly)", xlab="LST (2-month Mean)",cex=.5,pch=16,auto.key=list(space="right"),scales=list(x=list(rot=45)),
        layout=c(2,5))

```

# Processing Options

## Solution 1 (relatively easy)

1. Spatial interpolation: fill in LST when another observation is available within  some small distance (3? 5? 7? kilometers)
2. Temporal interpolation: Estimate the monthly value at the 15th day by linear interpolation (in the temporal domain) considering the temporally closest observations in the previous and following month.

This is more robust than the simple mean of 3 months.  For example, imagine using a simple mean in the following case:  
* month -1: no observation 
* month  0: no observation                                     
* month +1: observation in the end of the month

Would lead to a prediction = month +1.

Or, alternatively, one in which:
* month -1: has data for the full month
* month 0: has no data
* month +1: has only data near end of month

In this case a mean would be 'pulled' towards the mean value of month-1.  Using a fixed number of observations in t-1 and t+1 and a linear interpolation that accounts for the time of those observations would prevent 

## Solution 2 (complex - based on Kalman filter and ancillary model)

We could also re-imagine the interpolation of daily missing pixel values based on the temporal trend of previous and future observation driven by an ancillary modelled data [http://dx.doi.org/10.1016/j.rse.2007.07.007].  The modelled data can be obtained from external climate models such as NCEP Reanalysis (at >0.5 degree of resolution). For example:

![title](http://i.imgur.com/qZs0KZn.png)

However, this would require a major reorganization of how we are approaching the problem.

#  Remaining Questions  

1. How does this variability compare to spatial variability (e.g. which is worse, spatial or temporal smoothing)?
2. How do the anomolies from different temporal windows vary spatially?  
